---
title: éå¿…è¦ä¸ä½¿ç”¨ React.useEffect
date: 2025-04-20
lastmod: 2025-04-21T03:38:39.321Z
tags:
  - React Native
  - å‰ç«¯æ¡†æ¶
  - æ–°æŠ€æœ¯è¶‹åŠ¿
summary: '`useEffect` çš„ä½¿ç”¨å¤æ‚ï¼Œä¾èµ–å‚æ•°å½±å“æ‰§è¡Œæ—¶æœºï¼Œè¿‡åº¦ä½¿ç”¨æ˜“å¯¼è‡´ä»£ç æ··ä¹±ï¼Œå»ºè®®è°¨æ…ä½¿ç”¨ã€‚'
draft: false
images: []
---

`React.useEffect` å¯ä»¥è¯´æ˜¯æ‰€æœ‰ hooks ä¸­æœ€éš¾ä½¿ç”¨ï¼Œæœ€éš¾ç”¨å¥½çš„ä¸€ä¸ª hook äº†ã€‚

å®ƒçš„ç¬¬äºŒä¸ªå‚æ•° dependencies ï¼Œå½“ä¸ç©¿ï¼Œä¼ ç©ºï¼Œä¼ å¤šä¸ªçš„æ—¶å€™æ„ä¹‰å®Œå…¨ä¸ä¸€æ ·ã€‚

å½“ useEffect çš„ dependencies å‚æ•°ä¸ä¼ çš„æ—¶å€™ï¼Œæ‰§è¡Œçš„æ—¶æœºç›¸å½“äº class ç»„ä»¶çš„ `componentDidUpdate` ç”Ÿå‘½å‘¨æœŸã€‚

å½“ useEffect çš„ dependencies å‚æ•°ä¼ ç©ºæ•°ç»„çš„æ—¶å€™ï¼Œç›¸å½“äº class ç»„ä»¶çš„ `componentDidMount`ï¼Œ `componentWillUnmount`ã€‚

å½“ useEffect çš„ dependencies å‚æ•°éœ€è¦ä¼ å…·ä½“çš„ä¾èµ–çš„æ—¶å€™ï¼Œæ¯å½“ä¾èµ–é¡¹æ•°ç»„å˜åŒ–çš„æ—¶å€™ï¼Œéƒ½ä¼šæ‰§è¡Œã€‚

è¯´å®ƒéš¾ä½¿ç”¨ä¸»è¦æ˜¯ dependencies å‚æ•°æ— æ³•è‡ªåŠ¨åŒ–ï¼Œä¾èµ–äºäººå»è¯†åˆ«å’Œåˆ¤æ–­, å¢åŠ å¤æ‚åº¦ã€‚è¯´å®ƒéš¾ç”¨å¥½æ˜¯å› ä¸ºå¦‚æœå¼€å‘è€…å¾ˆå®¹æ˜“è¿‡åº¦åœ°ä½¿ç”¨ useEffect, é€ æˆä»£ç é€»è¾‘çš„æ··ä¹±ï¼Œå½¢æˆå±å±±ã€‚

### å¤§é‡æ„ä¹‰ä¸æ˜çš„ç©ºæ•°ç»„

å½“æˆ‘ä»¬éœ€è¦æ¨¡æ‹Ÿ `componentDidMount` çš„æ—¶å€™, é€šå¸¸ä¼šä¼ å…¥ä¸€ä¸ªç©ºæ•°ç»„ï¼Œè¡¨ç¤ºè¿™ä¸ª effect åªæ‰§è¡Œä¸€æ¬¡ã€‚

```javascript
useEffect(() => {
  init()
}, [])
```

åœ¨ä»£ç ä¸­ï¼Œå……æ–¥ç€å¤§é‡è¿™æ ·çš„ç©ºæ•°ç»„ï¼Œçœ‹ä¸Šå»å¾ˆå¤šä½™ï¼Œè€Œä¸”ä¸èƒ½ç›´è§‚åœ°åæ˜ å‡ºè¿™æ®µä»£ç çš„æ„å›¾ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è‡ªå®šä¹‰ hook æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

```javascript
const useInit = (init, dispose) => {
  React.useEffect(() => {
    if (isFunction(init)) {
      init()
    }
    return isFunction(dispose) ? dispose : undefined
  }, [])
}
```

### é—­åŒ…é—®é¢˜

åœ¨ useEffect å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬èƒ½è®¿é—®åˆ°çš„ç»„ä»¶ state å˜é‡å–å†³äºè¯¥ effect å‡½æ•°è¢«å®šä¹‰æ—¶æ‰€åœ¨çš„ä½œç”¨åŸŸã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæ²¡æœ‰å°†æ‰€æœ‰è®¿é—®åˆ°çš„ react å˜é‡éƒ½åŠ å…¥ä¾èµ–æ•°ç»„ä¸­ï¼Œé‚£ä¹ˆè®¿é—®åˆ°çš„æ•°æ®å°±æœ‰å¯èƒ½æ˜¯è¿‡æ—¶çš„ï¼Œä¸æ­£ç¡®çš„ã€‚

ä½†æ˜¯æˆ‘ä»¬ä¸€æ—¦å› ä¸ºè¦è§£å†³é—­åŒ…é—®é¢˜è€Œé™æ‰€æœ‰ä¾èµ–é¡¹éƒ½åŠ å…¥ï¼Œé‚£ä¹ˆä¼šé‡åˆ°å…¶ä»–æ›´éº»çƒ¦çš„é—®é¢˜ã€‚

```javascript
function ChatRoom = ({ roomId, theme }) => {
	useEffect(() => {
		const connection = createConnection(serverUrl, roomId)
		connection.on('connected', () => {
			showNotification('Connected!', theme)
		})

		connection.connect();
		return () => connection.disconnect()
	}, [roomId, theme])
}
```

åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå¦‚æœæˆ‘ä»¬ä¸å°† theme åŠ å…¥ä¾èµ–æ•°ç»„ä¸­ï¼Œåœ¨ connected äº‹ä»¶ä¸­è®¿é—®åˆ°çš„ theme å˜é‡å¯èƒ½æ˜¯æ—§çš„å€¼ã€‚å½“æˆ‘ä»¬å°†å…¶åŠ å…¥ä¾èµ–æ•°ç»„ä¹‹åï¼Œè™½ç„¶è§£å†³äº†è®¿é—®æ—§å€¼çš„é—®é¢˜ï¼Œä½†æ˜¯æ¯æ¬¡ä¿®æ”¹ theme çš„æ—¶å€™ï¼Œéƒ½ä¼šæ–­å¼€å’Œé‡è¿ï¼Œè¿™æ˜æ˜¾ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚

æˆ‘ä»¬å¯ä»¥å°† theme è½¬æ¢ä¸º ref (ä¾‹å¦‚ ahooks ä¸­çš„ useLatest), è¿™æ ·åœ¨ effect å‡½æ•°ä¸­è®¿é—®åˆ°çš„å€¼æ°¸è¿œéƒ½æ˜¯æœ€æ–°çš„äº†ã€‚

### è¿‡åº¦çš„å“åº”å¼ç¼–ç¨‹

useEffect æœ€å¤§çš„ä¸€ä¸ªé—®é¢˜æ˜¯å®¹æ˜“è®©äººä»¥"ç›‘å¬"çš„æ–¹å¼å»å†™ä»£ç ã€‚

```typescript
// æ¸²æŸ“è¿‡ç¨‹ä¹Ÿä¾èµ– pageNo å’Œ projectList è¿™ä¸¤ä¸ªçŠ¶æ€
const [pageNo, setPageNo] = useState(1)
const [projectList, setProjectList] = useState([])
const handlePageNoBtnClick = (targetPageNo) => {
  setPageNo(targetPageNo)
}

const handleNextPageBtnClick = () => {
  const targetPageNo = pageNo + 1
  setPageNo(targetPageNo)
}

const handlePrevPageBtnClick = () => {
  const targetPageNo = pageNo - 1
  setPageNo(targetPageNo)
}

// ğŸŸ¡ å½“ fetchProjectList å†…çš„é€»è¾‘è¢«ä¿®æ”¹åï¼Œéš¾ä»¥è¯„ä¼°è¿™ä¸ªæ”¹åŠ¨çš„å½±å“é¢
const fetchProjectList = useCallback(async () => {
  const query = qs.stringify({
    projectType: props.projectType, // projectType æ˜¯é€šè¿‡ props è·å¾—çš„
    pageSize: 20,
    pageNo,
  })
  const response = await fetch(`/project/list?${query}`)
  const json = await response.json()
  setProjectList(json)
}, [pageNo, props.projectType])

useEffect(() => {
  fetchProjectList()
}, [fetchProjectList])
```

å¦‚ä¸Šï¼Œåˆ†é¡µçš„åŠŸèƒ½è¢«åˆ‡å‰²æˆå¤šä¸ªå°çš„é€»è¾‘ç‰‡æ®µï¼Œä¾é  useEffect ä¸­çš„ä¾èµ–é¡¹æ¥è¿æ¥ã€‚
ä¾‹å¦‚ï¼š 'ç‚¹å‡»ä¸‹ä¸€é¡µ'çš„æµç¨‹æ˜¯
`ä¿®æ”¹PageNo` --> `è§¦å‘ fetchProjectList chanaged` --> `è§¦å‘ useEffectï¼Œé‡æ–°è¯·æ±‚æ•°æ®`ã€‚

è™½ç„¶æ¯ä¸ªç‰‡æ®µå†…çš„é€»è¾‘æ˜¯å®Œæ•´çš„ï¼Œä½†æ˜¯ç‰‡æ®µä¸ç‰‡æ®µä¹‹é—´çš„è”ç³»å¹¶ä¸ç›´è§‚å’Œæ¸…æ™°ï¼Œè¿™ç»™åç»­çš„ç»´æŠ¤å¸¦æ¥å¾ˆå¤§çš„éš¾åº¦ã€‚

å›åˆ°æ ‡é¢˜éƒ¨åˆ†ï¼Œä¸ºä»€ä¹ˆè¯´**éå¿…è¦ä¸ä½¿ç”¨ useEffect**, åŸå› å°±åœ¨äºè¿™é‡Œã€‚å½“æˆ‘ä»¬çš„ä»£ç ä¸­å……æ–¥ç€è¿™æ ·çš„çŠ¶æ€ç›‘å¬ç»„æˆçš„é€»è¾‘ï¼Œä¹Ÿå°±æ„å‘³ç€è¿™ä¸ªé¡¹ç›®å·²ç»å˜æˆå±å±±äº†ã€‚è¯•æƒ³ä¸€ä¸‹ï¼Œè¿™æ—¶å€™çš„ useEffect ä¸å°±æ˜¯å’Œ Vue çš„ `watch` `watchEffect` ä¸€æ ·äº†å—ï¼Œè€Œ Vue ç¼–ç¨‹çš„ä¸€ä¸ªå‡†åˆ™å°±æ˜¯**åœ¨ä½¿ç”¨ watch çš„æ—¶å€™ï¼Œè¯·æ€è€ƒ3éï¼Œæ˜¯å¦çœŸçš„éœ€è¦ watch**ã€‚

useEffect æ›´åå‘çš„åº”è¯¥æ˜¯ `effect` éƒ¨åˆ†ï¼Œå³ç”±çŠ¶æ€å˜åŒ–è§¦å‘çš„é€»è¾‘ã€‚
è€Œåƒä¸Šé¢çš„ä¾‹å­ä¸­çš„`ä¸Šä¸€é¡µ`ï¼Œ `ä¸‹ä¸€é¡µ` çš„åŠŸèƒ½éƒ½åº”è¯¥å±äº Event äº‹ä»¶ï¼Œä¸åº”è¯¥æ”¾åœ¨ Effect ä¸­å¤„ç†ã€‚

```typescript
import { useCallback, useEffect, useState } from "react";

type PaginationProps = {
  autoLoad?: boolean;
  defaultPageNo?: number;
  children: (list: Record<string, unknown>[]) => React.ReactNode;
  fetch: (ctx: { pageNo: number, pageSize: number }) => Promise<{ total: number, data: Record<string, unknown>[] }>;
};

export function Pagination(props: PaginationProps) {
  const [pageNo, setPageNo] = useState(props.defaultPageNo || 0)
  const [total, setTotal] = useState(0)
  const [list, setList] = useState<Record<string, unknown>[]>([])
  const pageSize = 10


  const fetchData = useCallback(async (pageNo: number, pageSize: number) => {
    const { total, data } = await props.fetch({ pageNo, pageSize });
    setTotal(total);
    setList(data)
  }, [])

  useInit(() => {
    if (typeof props.autoLoad === 'undefined' ? true : props.autoLoad) {
      fetchData(pageNo, pageSize);
    }
  })

  const handlePrev = () => {
    const newPageNo = Math.max(0, pageNo - 1)
    setPageNo(newPageNo);
    fetchData(newPageNo, pageSize);
  }

  const handleNext = () => {
    const newPageNo = pageNo + 1;
    setPageNo(newPageNo);
    fetchData(newPageNo, pageSize);
  }

  return (
    <div>
      {props.children(list)}
      {/* Pagination controls will go here */}
      <button onClick={() => handlePrev()} disabled={pageNo <= 0}>
        Previous
      </button>
      <span>Page {pageNo}</span>
      <span>Total: {total}</span>
      <button onClick={() => handleNext()}>
        Next
      </button>
    </div>
  );
}
```
